<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - {{#if mapObject.title}}{{ mapObject.title }}{{else}}New map{{/if}}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/jpg" href="/favicon.ico">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Inter", sans-serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-style: normal;
        }

        .key-message {
            position: absolute;
            bottom: 50px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
            background: var(--bg);
            padding: 10px;
            border-radius: 5px;
        }

        .key-message-code {
            background-color: black;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            color: red;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
        }

        .map-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            display: none;
        }

        .bottom-right {
            position: absolute;
            bottom: 20px;
            right: 10px;
            z-index: 1000;
            width: 25%;
        }

        .card {
            background-color: var(--bs-secondary-bg-subtle);
        }

        /* Small screens */
        @media (max-width: 768px) {
            .bottom-right {
                width: 100%;
                bottom: 0;
                right: 0;
            }

            #create-map-form .card-body {
                display: block;
            }

            #create-map-form .btn {
                width: 100%;
            }
        }
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script defer data-domain="mapisy.com" src="https://analytics.juanma.app/js/script.js"></script>
</head>
<body style="display: flex; flex-direction: column; height: 100vh;">
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div class="bottom-right">
        <div id="create-map-form" class="card">
            <div class="card-header">
                <h5 class="card-title m-0">Create map</h5>
                <button class="btn btn-primary" style="float: right;display: none;">
                    Create map
                </button>
            </div>
            <div class="card-body">
                <form id="configForm" method="post" action="/api/maps/{{ map }}">
                    <div class="mb-3">
                        <label for="email">Email <span style="color: red;">*</span></label>
                        <input class="form-control" type="text" name="email" placeholder="Email">
                        <div id="emailHelp" class="form-text">The API key will be sent to this email</div>
                    </div>
                    <div class="mb-3">
                        <label for="title">Title <span style="color: red;">*</span></label>
                        <input class="form-control" type="text" name="title" placeholder="Title">
                    </div>
                    <div class="mb-3">
                        <label for="description">Description</label>
                        <textarea class="form-control" name="description" placeholder="Description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="latitude">Center <span style="color: red;">*</span></label>
                        <input class="form-control" type="text" name="latitude" placeholder="Latitude">
                        <input class="form-control" type="text" name="longitude" placeholder="Longitude">
                    </div>
                    <div class="mb-3">
                        <label for="zoom">Zoom <span style="color: red;">*</span></label>
                        <input class="form-control" type="number" name="zoom" placeholder="Zoom">
                    </div>
                    <button type="submit" class="btn btn-primary">Create map</button>
                </form>
            </div>
        </div>
    </div>
        {{!-- <div class="map-info card" style="display: none;">
            <h1 style="margin: 0;font-size: 1.5rem;" id="map-title"></h1>
        <p id="map-description" style="display: none; margin: 10px 0 0;"></p>
        <div id="created-by" style="display: none; justify-content: flex-end;margin-top: 30px;">
            <small>Made with <a href="{{baseUrl}}">{{title}}</a></small>
        </div>
    </div>
    <div class="center-marker">×</div>
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">Create map</h5>
        </div>
        <div class="card-body">
            <form id="configForm" method="post" action="/api/maps/{{ map }}">
                <label for="email">Email <span style="color: red;">*</span></label>
            <input type="text" name="email" placeholder="Email">
            <h6 style="margin: 0;">The API key will be sent to this email</h6>
            <label for="title">Title <span style="color: red;">*</span></label>
            <input type="text" name="title" placeholder="Title">
            <br>
            <label for="description">Description</label>
            <textarea name="description" placeholder="Description"></textarea>
            <br>
            <label for="latitude">Center <span style="color: red;">*</span></label>
            <input type="text" name="latitude" placeholder="Latitude">
            <input type="text" name="longitude" placeholder="Longitude">
            <br>
            <label for="zoom">Zoom <span style="color: red;">*</span></label>
            <input type="number" name="zoom" placeholder="Zoom">
            <br>
            <button type="submit" class="button">Create map</button>
            </form>
        </div>
    </div> --}}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map', {
                center: [0, 0],
                zoom: 1,
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // if screen is small, make create-map-form hidable clicking and sliding de header
            function toggleCardBody() {
                if (window.innerWidth < 768) {
                    document.querySelector('.card-header').addEventListener('click', () => {
                        const cardBody = document.querySelector('.card-body');
                        cardBody.style.display = cardBody.style.display === 'none' ? 'block' : 'none';
                        document.querySelector('.btn').style.display = cardBody.style.display === 'none' ? 'block' : 'none';
                        document.querySelector('.card-title').style.display = cardBody.style.display === 'none' ? 'none' : 'block';
                    });
                } else {
                    document.querySelector('.card-body').style.display = 'block';
                }
            }

            toggleCardBody();
            window.addEventListener('resize', toggleCardBody);

            // TODO: delete id
            const id = window.location.pathname.split('/').pop();

            function connectSocket() {
                socket = io();

                socket.on('marker:created', function({ marker }) {
                    if (marker.map_id !== id) return;

                    L.marker([parseFloat(marker.latitude), parseFloat(marker.longitude)], {
                        id: marker._id.toString()
                    })
                    .bindPopup(marker.title || marker._id)
                    .on('click', function(e) {
                        this.openPopup(); // Muestra el popup al clicar
                        navigator.clipboard.writeText(marker._id.toString());
                    })
                    .addTo(map)
                    .openPopup(); // Abre el popup por defecto

                    markers.push(marker);
                });

                socket.on('marker:deleted', function({ marker }) {
                    if (marker.map_id !== id) return;

                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Marker && layer.options.id === marker._id.toString()) {
                            map.removeLayer(layer);
                        }
                    });
                });

                socket.on('map:updated', function({ map: currentMap }) {
                    if (currentMap.id !== id) return;

                    map.setView([currentMap.latitude, currentMap.longitude], currentMap.zoom);
                    document.getElementById('map-title').textContent = currentMap.title;
                    document.getElementById('map-description').textContent = currentMap.description;
                    document.getElementById('map-description').style.display = currentMap.description ? 'block' : 'none';
                });

                socket.on('connect_error', (error) => {
                    console.error('Error de conexión:', error);
                });
            }

            let markers = [];
            let socket;

            const userMap = JSON.parse('{{{ map }}}');
            document.getElementById('configForm').setAttribute('action', `/${id}`);

            map.setView([userMap.latitude, userMap.longitude], userMap.zoom);

            if (userMap.title) {
                document.querySelector('.map-info').style.display = 'block';
                document.getElementById('map-title').textContent = userMap.title;
                document.getElementById('map-description').textContent = userMap.description;
                document.getElementById('map-description').style.display = userMap.description ? 'block' : 'none';
            }

            if (!userMap.new) {
                document.querySelector('.center-marker').style.display = 'none';
                document.querySelector('.key-message').style.display = 'none';
                if (userMap.title !== 'Demo') {
                    document.getElementById('created-by').style.display = 'flex';
                }
            }

            if (!userMap.email) {
                const smallScreen = window.innerWidth < 768;
                if (smallScreen) {
                    window.location.href = '/';
                }
                const lat = document.querySelector('[name="latitude"]').value || '0';
                const lng = document.querySelector('[name="longitude"]').value || '0';
            }

            userMap.markers.forEach(marker => {
                L.marker([parseFloat(marker.latitude), parseFloat(marker.longitude)])
                    .bindPopup(marker.title || marker._id)
                    .on('click', function(e) {
                        this.openPopup(); // Muestra el popup al clicar
                        navigator.clipboard.writeText(marker._id.toString());
                    })
                .addTo(map);
            });

            connectSocket();

            document.querySelector('[name="zoom"]').addEventListener('change', (e) => {
                const newZoom = parseInt(e.target.value);
                if (!isNaN(newZoom)) {
                    const limitedZoom = Math.min(Math.max(newZoom, 0), 19);
                    e.target.value = limitedZoom;
                    map.setZoom(limitedZoom);
                }
            });

            map.on('zoom', function() {
                document.querySelector('[name="zoom"]').value = parseInt(map.getZoom().toFixed(0));
            });

            map.on('moveend', function() {
                const center = map.getCenter();
                document.querySelector('[name="latitude"]').value = center.lat.toFixed(6);
                document.querySelector('[name="longitude"]').value = center.lng.toFixed(6);
            });

            document.querySelector('[name="title"]').addEventListener('input', (e) => {
                document.querySelector('.map-info').style.display = e.target.value ? 'block' : 'none';
                document.getElementById('map-title').textContent = e.target.value;
                document.getElementById('map-description').textContent = document.querySelector('[name="description"]').value;
            });

            document.querySelector('[name="description"]').addEventListener('input', (e) => {
                document.querySelector('.map-info').style.display = e.target.value ? 'block' : 'none';
                document.getElementById('map-description').style.display = e.target.value ? 'block' : 'none';
                document.getElementById('map-description').textContent = e.target.value;
            });

            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');
            if (message) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                toast.style.backgroundColor = '#a04848';
                toast.style.color = 'var(--text)';
                toast.style.padding = '10px';
                toast.style.borderRadius = '5px';
                toast.style.position = 'absolute';
                toast.style.bottom = '10px';
                toast.style.right = '10px';
                toast.style.zIndex = '1000';
                toast.style.width = '50%';
                document.querySelector('.key-message').appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        });
    </script>
</body>
</html>
