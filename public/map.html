<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidencias DANA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="icon" type="image/jpg" href="/favicon.jpg">
    <script defer data-domain="incidenci.es" src="https://analytics.juanma.app/js/script.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        .info-card {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .whatsapp-link {
            color: #25D366;
            text-decoration: none;
            font-weight: bold;
        }

        .telegram-link {
            color: #0088cc;
            text-decoration: none;
            font-weight: bold;
        }

        .whatsapp-link:hover {
            text-decoration: underline;
        }
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div class="info-card">
        Mapa de incidencias de DANA
        <div style="display: flex; justify-content: space-between; gap: 10px;">
            <a href="https://wa.me/34623958700?text=Hola" class="whatsapp-link" target="_blank">WhatsApp</a>
            <a href="https://t.me/dana_incidencies_bot" class="telegram-link" target="_blank">Telegram</a>
        </div>
    </div>
    <script>
        var map = L.map('map', {
            center: [40.4167, -3.7033],
            zoom: window.innerWidth < 768 ? 5 : 7,
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        let incidenceData = [];
        let socket;

        function connectSocket() {
            socket = io();

            socket.on('nueva_incidencia', function(incidence) {
                incidence = JSON.parse(incidence);
                L.marker([parseFloat(incidence.latitude), parseFloat(incidence.longitude)], {
                    icon: incidence.status === 'grave' ?
                        L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        }) : L.Icon.Default.prototype
                })
                .bindPopup(function(layer) {
                    const coords = layer.getLatLng();
                    return `<b>Latitud:</b> ${coords.lat}<br>
                            <b>Longitud:</b> ${coords.lng}<br>
                            <b>Descripción:</b> ${incidence.description}`;
                })
                .addTo(map);

                incidenceData.push(incidence);
            });

            socket.on('connect_error', (error) => {
                console.error('Error de conexión:', error);
            });
        }

        fetch('/map')
        .then(response => response.json())
        .then(data => {
            incidenceData = data.list;

            return fetch('https://unpkg.com/es-atlas/es/autonomous_regions.json');
        })
        .then(response => response.json())
        .then(topology => {
            const geojson = topojson.feature(topology, topology.objects.autonomous_regions);

            incidenceData.forEach(incidence => {
                L.marker([parseFloat(incidence.latitude), parseFloat(incidence.longitude)], {
                    icon: incidence.status === 'grave' ?
                        L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        }) : L.Icon.Default.prototype
                })
                .bindPopup(function(layer) {
                    const coords = layer.getLatLng();
                    return `<b>Latitud:</b> ${coords.lat}<br>
                            <b>Longitud:</b> ${coords.lng}<br>
                            <b>Descripción:</b> ${incidence.description}`;
                })
                .addTo(map);
            });

            L.geoJSON(geojson, {
                style: {
                    color: '#000',
                    weight: 1,
                    fillColor: '#ccc',
                    fillOpacity: 0.3
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.name) {
                        const bounds = layer.getBounds();

                        const gravesCount = incidenceData.filter(inc => {
                            const lat = parseFloat(inc.latitude);
                            const lng = parseFloat(inc.longitude);
                            return inc.status === 'grave' && bounds.contains([lat, lng]);
                        }).length;

                        const levesCount = incidenceData.filter(inc => {
                            const lat = parseFloat(inc.latitude);
                            const lng = parseFloat(inc.longitude);
                            return inc.status !== 'grave' && bounds.contains([lat, lng]);
                        }).length;

                        layer.bindPopup(
                            `<b>${feature.properties.name}</b><br>
                            Incidencias graves: ${gravesCount}<br>
                            Incidencias leves: ${levesCount}`
                        );
                    }
                }
            }).addTo(map);

            connectSocket();
        })
        .catch(error => console.error('Error:', error));
    </script>
</body>
</html>
