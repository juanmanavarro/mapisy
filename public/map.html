<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidencias DANA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="icon" type="image/jpg" href="/favicon.jpg">
    <script defer data-domain="incidenci.es" src="https://analytics.juanma.app/js/script.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <script>
        var map = L.map('map', {
            center: [0, 0],
            zoom: 1,
        });

        const id = window.location.pathname.split('/').pop();

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        let markers = [];
        let socket;

        function connectSocket() {
            socket = io();

            socket.on('marker:created', function(marker) {
                if (marker.map_id !== id) return;

                L.marker([parseFloat(marker.latitude), parseFloat(marker.longitude)], {
                    icon: marker.status === 'grave' ?
                        L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        }) : L.Icon.Default.prototype
                })
                .bindPopup(function(layer) {
                    const coords = layer.getLatLng();
                    return `<b>Latitud:</b> ${coords.lat}<br>
                            <b>Longitud:</b> ${coords.lng}`;
                })
                .addTo(map);

                markers.push(marker);
            });

            socket.on('connect_error', (error) => {
                console.error('Error de conexión:', error);
            });
        }

        fetch(`/api/map/${id}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(incidence => {
                    L.marker([parseFloat(incidence.latitude), parseFloat(incidence.longitude)], {
                        icon: incidence.status === 'grave' ?
                            L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            }) : L.Icon.Default.prototype
                    })
                    .bindPopup(function(layer) {
                        const coords = layer.getLatLng();
                        return `<b>Latitud:</b> ${coords.lat}<br>
                                <b>Longitud:</b> ${coords.lng}<br>
                                <b>Descripción:</b> ${incidence.description}`;
                    })
                    .addTo(map);
                });

                connectSocket();
            })
            .catch(error => console.error('Error:', error));
    </script>
</body>
</html>
