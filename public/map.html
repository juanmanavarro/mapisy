<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incidencias DANA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="icon" type="image/jpg" href="/favicon.jpg">
    <script defer data-domain="incidenci.es" src="https://analytics.juanma.app/js/script.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        .key-message {
            position: absolute;
            bottom: 50px;
            right: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .key-message-code {
            background-color: black;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            color: red;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
        }
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div class="center-marker">×</div>
    <div class="key-message">
        <div class="key-message-code">
            <pre id="curl-command"></pre>
            <button id="copyButton" style="margin-top: 5px;">Copiar comando</button>
        </div>
        <small>Save this command to use the API. The API key will not be shown again.</small>
        <form id="configForm" method="post">
            <label for="latitude">Center</label>
            <input type="text" name="latitude" placeholder="Latitude">
            <input type="text" name="longitude" placeholder="Longitude">
            <br>
            <label for="zoom">Zoom</label>
            <input type="number" name="zoom" placeholder="Zoom">
            <br>
            <button type="submit">Create</button>
        </form>
    </div>
    <script>
        var map = L.map('map', {
            center: [0, 0],
            zoom: 1,
        });

        const id = window.location.pathname.split('/').pop();

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        let markers = [];
        let socket;

        function connectSocket() {
            socket = io();

            socket.on('marker:created', function(marker) {
                if (marker.map_id !== id) return;

                L.marker([parseFloat(marker.latitude), parseFloat(marker.longitude)], {
                    icon: marker.status === 'grave' ?
                        L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        }) : L.Icon.Default.prototype
                })
                .addTo(map);

                markers.push(marker);
            });

            socket.on('connect_error', (error) => {
                console.error('Error de conexión:', error);
            });
        }

        fetch(`/api/maps/${id}`)
            .then(response => response.json())
            .then(data => {
                map.setView([data.latitude, data.longitude], data.zoom);

                if (!data.isNew) {
                    document.querySelector('.center-marker').style.display = 'none';
                }

                if (data.api_key) {
                    document.querySelector('.key-message').style.display = 'flex';
                    const lat = document.querySelector('[name="latitude"]').value || '40.416775';
                    const lng = document.querySelector('[name="longitude"]').value || '-3.703790';

                    const curlCommand = `curl -X POST \\
    '${window.location.origin}/api/maps/${id}/markers' \\
    -H 'Content-Type: application/json' \\
    -H 'Authorization: Bearer ${data.api_key}' \\
    -d '{
        "latitude": ${lat},
        "longitude": ${lng}
}'`;
                    document.getElementById('curl-command').textContent = curlCommand;
                }

                data.markers.forEach(marker => {
                    L.marker([parseFloat(marker.latitude), parseFloat(marker.longitude)], {
                        icon: marker.status === 'grave' ?
                            L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            }) : L.Icon.Default.prototype
                    })
                    .addTo(map);
                });

                connectSocket();
            })
            .catch(error => console.error('Error:', error));

        document.getElementById('configForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(document.getElementById('configForm'));
            const data = {
                latitude: formData.get('latitude'),
                longitude: formData.get('longitude'),
                zoom: formData.get('zoom')
            };

            fetch(`/api/maps/${id}/config`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    const curlCommand = document.getElementById('curl-command').textContent;
                    navigator.clipboard.writeText(curlCommand)
                        .then(() => {
                            alert('¡Comando copiado al portapapeles!');
                            window.location.reload();
                        })
                        .catch(err => {
                            console.error('Error al copiar:', err);
                            window.location.reload();
                        });
                } else {
                    console.error('Error al guardar la configuración');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        document.getElementById('copyButton').addEventListener('click', () => {
            const curlCommand = document.getElementById('curl-command').textContent;
            navigator.clipboard.writeText(curlCommand)
                .then(() => alert('¡Comando copiado al portapapeles!'))
                .catch(err => console.error('Error al copiar:', err));
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetch(`/api/maps/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.querySelector('[name="latitude"]').value = data.latitude;
                    document.querySelector('[name="longitude"]').value = data.longitude;
                    document.querySelector('[name="zoom"]').value = data.zoom;
                });
        });

        document.querySelector('[name="zoom"]').addEventListener('change', (e) => {
            const newZoom = parseInt(e.target.value);
            if (!isNaN(newZoom)) {
                // Limitar el zoom entre 0 y 19
                const limitedZoom = Math.min(Math.max(newZoom, 0), 19);
                e.target.value = limitedZoom; // Actualizar el valor del input si estaba fuera de rango
                map.setZoom(limitedZoom);
            }
        });

        map.on('zoom', function() {
            document.querySelector('[name="zoom"]').value = parseInt(map.getZoom().toFixed(0));
        });

        // Agregar este nuevo evento para actualizar lat/lng cuando el mapa se mueve
        map.on('moveend', function() {
            const center = map.getCenter();
            document.querySelector('[name="latitude"]').value = center.lat.toFixed(6);
            document.querySelector('[name="longitude"]').value = center.lng.toFixed(6);

            if (document.getElementById('curl-command').textContent) {
                const lat = center.lat.toFixed(6);
                const lng = center.lng.toFixed(6);
                const apiKey = document.getElementById('curl-command').textContent.match(/Bearer\s+([^\n']+)/)[1];

                const curlCommand = `curl -X POST \\
    '${window.location.origin}/api/maps/${id}/markers' \\
    -H 'Content-Type: application/json' \\
    -H 'Authorization: Bearer ${apiKey}' \\
    -d '{
        "latitude": ${lat},
        "longitude": ${lng}
    }'`;
                document.getElementById('curl-command').textContent = curlCommand;
            }
        });
    </script>
</body>
</html>
